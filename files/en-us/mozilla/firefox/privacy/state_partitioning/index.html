---
title: State Partitioning
slug: Mozilla/Firefox/Privacy/state_partitioning
tags:
  - Firefox
  - Privacy
  - Mozilla
  - tracking
---

<div>{{FirefoxSidebar}}</div>

<p class="summary">
  State Partitioning is a broad effort to rework how Firefox manages client-side
  state (i.e., data stored in the browser) to mitigate the ability of websites
  to abuse state for cross-site tracking. This effort aims to
  achieve that by providing what is effectively a "different", isolated storage
  location to every website a user visits. This article gives an overview of
  the mechanism, lists the affected APIs and explains how to debug affected
  sites.
  <br>
  <br>
  State Partitioning is currently turned on by default in the Firefox Nightly
  channel. A subset of the state partitioning efforts (namely <a href="#network_partitioning">
    network partitioning</a>) has been enabled by default in the release channel
  of Firefox since version 85.
</p>

<!-- TODO: order and hierarchy of these sections -->

<h2>Motivation</h3>
<h3>Cross-site tracking using shared state</h2>
<p>
  Browsers traditionally key client-side state by the origin (or sometimes
  registrable domain) of the location a resource was loaded from. For example,
  the cookies, localStorage objects, and caches available to an iframe loaded
  from <code>https://tracker.example/hello.html</code> will be keyed by
  <code>tracker.example</code>. This is true regardless of whether the browser
  is currently loading the tracker as a <i>first party</i> website or as an
  embedded <i>third party</i> resource. Trackers have taken advantage of this
  cross-site state to store user identifiers and access them across websites.
  The example below shows how <code>tracker.example</code> is able to use its
  cross-site state (in this instance, cookies) to track a user across its
  own site as well as <code>A.example</code> and <code>B.example</code>.
</p>
<img src="example-cross-site-tracking.png" alt="An example of cross-site tracking">

<h3>Past approaches to blocking cross-site tracking</h3>
<p>
  Firefox's past cookie policies attempt to mitigate tracking by blocking
  access to some storage APIs (e.g., cookies and localStorage) for certain
  domains under certain conditions. For example, our "block all third-party
  cookies" policy will prevent all domains from accessing certain storage APIs
  when loaded in a third-party context. Our current
  <a href="en-US/docs/Mozilla/Firefox/Privacy/Storage_access_policy">
    default cookie policy
  </a> blocks access in a third-party context only for domains classified as
  trackers.
</p>

<h2 id="state_partitioning">State Partitioning</h2>
<p>
  State Partitioning is a different approach to blocking cross-site tracking.
  Rather than block access to certain stateful APIs in a third-party context,
  Firefox provides embedded resources with a separate storage
  bucket for every top-level website. More specifically, Firefox double-keys
  all client side state by the
  <i><a class="external" href="https://html.spec.whatwg.org/#origin">origin</a></i>
  of the resource being loaded and by the <i>top-level
  <a class="external" href="https://html.spec.whatwg.org/multipage/origin.html#site">site</a></i>.
  In most instances the top-level site is the scheme and eTLD+1 of the top-level
  page being visited by the user.
</p>
<p>
  In the example below <code>tracker.example</code> is embedded in
  <code>A.example</code> and <code>B.example</code>. However, since storage is
  partitioned, there are three distinct storage buckets (instead of one). The tracker can still
  access storage, but since every storage bucket is additionally keyed under the
  top-level site, the data it has access to on A will be different than the data
  on B. This will prevent a tracker from storing an identifier in their cookies
  when visited directly and then retrieving that identifier when embedded in
  other websites.
</p>
<img src="example-storage-partitioning.png" alt="An example of storage partitioning">
<h3>Standardization</h3>
<p>
  The <a class="external" href="https://privacycg.github.io/">Privacy Community
  Group</a> has a Work Item for
  <a class="external" href="https://privacycg.github.io/storage-partitioning/">
  Client-Side Storage Partitioning</a>. This serves as an overview for the
  standardization efforts for storage partitioning in the individual standards affected.
  We intent to align our state partitioning implementation with these efforts
  as the Work Item is standardized.
</p>

<h3>Status of partitioning in Firefox</h3>
<table class="standard-table">
  <tbody>
   <tr>
    <th scope="row"><a href="#network_partitioning">Network Partitioning</a></th>
    <td>Enabled by default for all users since Firefox 85.</td>
   </tr>
   <tr>
    <th scope="row"><a href="#dynamic_state_partitioning">Dynamic State Partitioning</a></th>
    <td>Enabled by default in <a href="/en-US/docs/Mozilla/Firefox#firefox_nightly">Firefox Nightly</a>. <br>
      Since Firefox 86: Enabled for users that have
      <a class="external"
        href="https://support.mozilla.org/en-US/kb/enhanced-tracking-protection-firefox-desktop#w_strict-enhanced-tracking-protection">
        "Strict" privacy protections
      </a> enabled.</td>
   </tr>
  </tbody>
 </table>
</p>

<h3 id="network_partitioning">Network Partitioning</h2>
  <p>Networking-related APIs are not intended to be used for websites to store
  data, but they can be
  <a class="external" href="https://blog.mozilla.org/security/2021/01/26/supercookie-protections/">abused</a>
  for cross-site tracking. As such, the following
  network APIs and caches are <strong>permanently</strong> partitioned by top-level site.
  <div class="note">
    <p><strong>Note</strong>: Network Partitioning is permanent. Websites can't control or relax these restrictions.</p>
  </div>
  <h4>Partitioned APIs</h4>
  <ul>
    <!-- TODO: Consider cross-linking more of these APIs -->
    <li><a href="/en-US/docs/Web/HTTP/Caching">HTTP Cache</a></li>
    <li>Image Cache</li>
    <li>Favicon Cache</li>
    <li>Connection Pooling</li> <!-- TODO: developer facing? -->
    <li>Stylesheet Cache</li>
    <li><a href="/en-US/docs/Glossary/DNS">DNS</a></li>
    <li>HTTP Authentication</li>
    <li><a href="/en-US/docs/Web/HTTP/Headers/Alt-Svc">Alt-Svc</a></li>
    <li>Speculative Connections</li>
    <li>Fonts & Font Cache</li>
    <li><a href="/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security">HSTS</a></li>
    <li>OCSP</li>
    <li>Intermediate CA Cache</li>
    <li>TLS Client Certificates</li>
    <li>TLS Session Identifiers</li>
    <li>Certificate Exceptions</li> <!-- FIXME: not implemented yet? -->
    <li>Prefetch</li>
    <li>Preconnect</li>
    <li><a href="/en-US/docs/Glossary/Preflight_request">CORS-preflight</a> Cache</li>
  </ul>
<h3 id="dynamic_state_partitioning">Dynamic Partitioning</h2>
  <p>To prevent cross-site tracking via JavaScript accessible storage APIs,
  Firefox partitions them for third-parties by top-level site. As opposed to
  Network Partitioning this boundary is dynamic and storage access to the
  embedders context maybe be granted in certain circumstances.
  <p>Firefox implements the
  <a href="#storage_access_api">StorageAccessAPI</a> to allow frames to request
  access to the parent storage. Access to top-level storage may also be granted
  automatically in specific scenarios. <a href="#partitioning_heuristics">You
  can read more about these heuristics here.</a></p>

  <h4>Partitioned APIs</h4>
  <ul>
    <li><a href="/en-US/docs/Web/API/Document/cookie">Cookies</a></li>
    <li><a href="/en-US/docs/Web/API/Window/localStorage">localStorage</a></li>
    <li><a href="/en-US/docs/Web/API/Window/sessionStorage">sessionStorage</a></li>
    <li><a href="/en-US/docs/Web/API/Cache">DOM Cache</a></li>
    <li><a href="/en-US/docs/Web/API/IndexedDB_API">IndexedDB</a></li>
    <li><a href="/en-US/docs/Web/API/BroadcastChannel">Broadcast Channel</a></li>
    <li><a href="/en-US/docs/Web/API/SharedWorker">Shared Workers</a></li>
    <li><a href="/en-US/docs/Web/API/Service_Worker_API">Service Workers</a></li>
  </ul>

  <h4 id="partitioning_heuristics">Storage Access Heuristics</h4>
  <p>In order to maintain web compatibility Firefox employs heuristics to grant
  storage access automatically.</p>

  <h5>Opener Heuristic</h5>
  <p>
    TODO
    <!-- TODO: Is this the same heuristic as described here:
    https://developer.mozilla.org/en-US/docs/Mozilla/Firefox/Privacy/Storage_access_policy#Automatic_storage_access_upon_interaction
    -->
  </p>

  <h5>Redirect Heuristic</h5>
  <p>Dynamic State Partitioning has a heuristic to enable typical login
  flows:</p>
  <p>If a site <code>b.example</code> redirects to <code>a.example</code>, then
  <code>b.example</code> receives storage access to its embedder
  <code>a.example</code> if both <code>a.example</code> and
  <code>b.example</code> have been visited and interacted with within the last 10
  minutes. This storage access will be granted for 30 days.</p>
  <div class="warning">
    <p><strong>Warning</strong>: Storage access heuristics are a transitional
    feature meant to prevent website breakage. They should not be relied upon
    for current and future web development.</p>
  </div>
  <h4 id="storage_access_api">Storage Access API</h5>
  <p>
    Third-party frames may use
    <a href="/en-US/docs/Web/API/Document/requestStorageAccess">
      <code>document.requestStorageAccess</code>
    </a>
    to request access to the first party storage through the
    <a href="/en-US/docs/Web/API/Storage_Access_API">StorageAccessAPI</a>. Once
    granted any requests from the third party frame to storage APIs will be made
    in the context of the first-party.
    <!-- TODO: describe what implications this has on previously partitioned storage -->
  </p>

<h3 id="debugging">Debugging</h2>
<p>
  We encourage site owners to test their sites, particularly those that rely on
  third-party content integrations. There are several features in Firefox to make
  testing easier.
</p>


<h4>Logging</h3>
<p>
  Here is an overview of the messages logged to the web console when
  interacting with storage in a third-party context. In the following examples
<code>a.example</code> is the top level site which embeds the third-party frame
<code>b.example</code>.
</p>

<table class="standard-table">
  <thead>
    <tr>
     <th scope="col">Reason</th>
     <th scope="col">Console Message</th>
    </tr>
   </thead>
  <tbody>
   <tr>
    <th scope="row">Storage of a third-party frame is partitioned</th>
    <td>Partitioned cookie or storage access was provided to “b.example” because it is loaded in the third-party context and storage partitioning is enabled.</td>
   </tr>
   <tr>
    <th scope="row">Storage access is granted through a <b>heuristic</b></th>
    <td>Storage access automatically granted for First-Party isolation “b.example” on “a.example”.</td>
   </tr>
   <tr>
    <th scope="row">Storage access is granted via the <a href="/en-US/docs/Web/API/Document/requestStorageAccess">StorageAccessAPI</a></th>
    <td>Storage access granted for origin “b.example” on “a.example”.</td>
   </tr>
  </tbody>
 </table>

<h4>Clear Third-Party Storage-Access</h4>
<p>
  If a third-party iframe is granted storage access to the parent context,
  Firefox sets a permission. To revoke access you can clear the permission via
  the <a class="external"
  href="https://support.mozilla.org/en-US/kb/site-information-panel">Site
  Information Panel</a> in the permissions section under "Cross-site Cookies".
</p>

<h4>Test Preferences</h3>
<div class="warning">
  <p><strong>Warning</strong>: Make sure to set these prefs in a separate Firefox
  profile or reset them after testing.</p>
</div>

<h5>Disable Heuristics</h4>
<p>
  The following prefs can be used to disable individual storage access
  heuristics via the <a
  class="external"href="https://support.mozilla.org/en-US/kb/about-config-editor-firefox">config
  editor</a>:
</p>
<ul>
  <li><code>privacy.restrict3rdpartystorage.heuristic.recently_visited</code>:
  Allow storage access after redirect for recently visited pages.</li>
  <li><code>privacy.restrict3rdpartystorage.heuristic.recently_visited_time</code>: Allowed time gap since last visit in seconds.</li>
  <li><code>privacy.restrict3rdpartystorage.heuristic.redirect</code>: TODO</li>
  <li><code>privacy.restrict3rdpartystorage.heuristic.window_open</code>: Allow storage access for windows opened using window.open()</li>
</ul>

<h5>Disable Network Partitioning</h4>
<p>Network partitioning can be disabled with the
<code>privacy.partition.network_state</code> pref.</p>

<h5>Disable Dynamic State Partitioning</h5>
<p>To disable dynamic storage partitioning for all sites you can use the
<code>network.cookie.cookieBehavior</code> pref:</p>
<table class="standard-table">
  <thead>
    <tr>
     <th scope="col">Value</th>
     <th scope="col">Description</th>
    </tr>
   </thead>
  <tbody>
   <tr>
    <th scope="row">5</th>
    <td>Reject (known) trackers and partition third-party storage.</td>
   </tr>
   <tr>
    <th scope="row">4</th>
    <td>Only reject trackers (Storage partitioning disabled).</td>
   </tr>
   <tr>
    <th scope="row">0</th>
    <td>Allow all</td>
   </tr>
  </tbody>
 </table>

 <p>Partitioning of third-party storage can also be disabled for specific
 origins with the <code>privacy.restrict3rdpartystorage.skip_list</code>
 preference. This pref holds a comma separated list of origins to exempt. For
 example:
</p>
<pre class="notranslate">
 <code>https://tracker.example.com,http://example.com</code>
</pre>
