---
title: Storage Partitioning
slug: Mozilla/Firefox/Privacy/storage_partitioning
tags:
  - Firefox
  - Privacy
  - Mozilla
  - tracking
---

<div>{{FirefoxSidebar}}</div>

<p class="summary">
  Storage Partitioning is a privacy feature that prevents embedded third-party
  iframes from having cross-site access to cookies and site data. This article
  gives an overview of the mechanism, lists the affected APIs and explains how
  to debug affected sites.
  <!-- TODO: What else? -->
</p>

<!-- TODO: order and hierarchy of these sections -->

<h2>Intro</h3>
<h3>Third-Party Cross-Site Tracking</h2>
<p>
  Embedded sites share state with their top-level
  <a class="external"
  href="https://html.spec.whatwg.org/#obtain-a-site">site</a>. This enables
  tracking users across different sites. A site embedded by multiple different
  top-level sites can use browser state to track users across them. For example,
  if a third-party tracking site <code>tracker.example</code> is embedded in a
  top-level site <code>A.example</code> and a top-level site
  <code>B.example</code>, besides its own first-party storage, it can access
  storage of both A and B, set unique identifiers for users, and identify them
  across both sites.
</p>
<img src="example-cross-site-tracking.png" alt="An example of cross-site tracking">
<h3>Blocking Known Trackers</h3>
<p>
  Known trackers can be blocked from accessing storage in third party context
  through a deny-list. However, this approach doesn't account for unknown
  trackers. It also breaks sites which rely on tracking third-parties requiring
  storage access to provide functionality.
  <!-- TODO: Can we link to a site that explains blocklist based ETP in-depth?
    https://developer.mozilla.org/en-US/docs/Mozilla/Firefox/Privacy/Tracking_Protection
    seems outdated  -->
</p>

<h2 id="storage_partitioning">Storage Partitioning</h2>
<p>
  Storage Partitioning is a more generic approach to blocking cross-site
  tracking. Third-party iframes embedded in a site will get a separate storage
  bucket for every top-level site they are embedded in. Partitioned state
  prevents third-party frames from tracking the user, while still allowing them
  to use network and storage APIs. This is more effective in blocking tracking
  than deny-listing and results in less website breakage.
</p>
<p>
  In the example below <code>tracker.example</code> is embedded in
  <code>A.example</code> and <code>B.example</code>. However, since storage is
  partitioned, there are three distinct storage buckets instead of one. The tracker can still
  access storage, but since every storage bucket is additionally keyed under the
  top-level site it cannot access storage across A and B.
</p>
<img src="example-storage-partitioning.png" alt="An example of storage partitioning">
<h3>Standardization</h3>
<p>
  The <a class="external" href="https://privacycg.github.io/">Privacy Community
  Group</a> has a  Work Item for
  <a class="external" href="https://privacycg.github.io/storage-partitioning/">
  Client-Side Storage Partitioning</a>. This serves as an overview for the
  standardization efforts for storage partitioning in the individual standards affected.
</p>

<h3>Partitioning in Firefox</h3>
<table class="standard-table">
  <tbody>
   <tr>
    <th scope="row"><a href="#network_partitioning">Network Partitioning</a></th>
    <td>Enabled by default for all users since Firefox 85.</td>
   </tr>
   <tr>
    <th scope="row"><a href="#dynamic_storage_partitioning">Dynamic Storage Partitioning</a></th>
    <td>Enabled by default in <a href="/en-US/docs/Mozilla/Firefox#firefox_nightly">Firefox Nightly</a>. <br>
      Since Firefox 86: Enabled for users that have
      <a class="external"
        href="https://support.mozilla.org/en-US/kb/enhanced-tracking-protection-firefox-desktop#w_strict-enhanced-tracking-protection">
        "Strict" privacy protections
      </a> enabled.</td>
   </tr>
  </tbody>
 </table>
</p>

<h3 id="network_partitioning">Permanent Network Partitioning</h2>
  <p>Networking-related APIs are not intended to be used for websites to store
  data, but they can be abused for cross-site tracking. Network partitioning
  prevents this by isolating affected APIs by top-level site.</p>
  <div class="note">
    <p><strong>Note</strong>: Network Partitioning is permanent. Websites can't control or relax these restrictions.</p>
  </div>
  <h4>Partitioned APIs</h4>
  <ul>
    <!-- TODO: Consider cross-linking more of these APIs -->
    <li><a href="/en-US/docs/Web/HTTP/Caching">HTTP Cache</a></li>
    <li>Image Cache</li>
    <li>Favicon Cache</li>
    <li>Connection Pooling</li> <!-- TODO: developer facing? -->
    <li>Stylesheet Cache</li>
    <li><a href="/en-US/docs/Glossary/DNS">DNS</a></li>
    <li>HTTP Authentication</li>
    <li><a href="/en-US/docs/Web/HTTP/Headers/Alt-Svc">Alt-Svc</a></li>
    <li>Speculative Connections</li>
    <li>Fonts & Font Cache</li>
    <li><a href="/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security">HSTS</a></li>
    <li>OCSP</li>
    <li>Intermediate CA Cache</li>
    <li>TLS Client Certificates</li>
    <li>TLS Session Identifiers</li>
    <li>Certificate Exceptions</li> <!-- FIXME: not implemented yet? -->
    <li>Prefetch</li>
    <li>Preconnect</li>
    <li><a href="/en-US/docs/Glossary/Preflight_request">CORS-preflight</a> Cache</li>
  </ul>
<h3 id="dynamic_storage_partitioning">Dynamic Partitioning</h2>
  <p>To prevent cross-site tracking via JavaScript accessible storage APIs,
  Firefox partitions them for third-parties by top-level site. As opposed to
  Network Partitioning this boundary is dynamic and storage access to the
  embedders context maybe be granted in certain circumstances.
  <p>Firefox implements the
  <a href="#storage_access_api">StorageAccessAPI</a> to allow frames to request
  access to the parent storage. Access to top-level storage may also be granted
  automatically in specific scenarios. <a href="#partitioning_heuristics">You
  can read more about these heuristics here.</a></p>

  <h4>Partitioned APIs</h4>
  <ul>
    <li><a href="/en-US/docs/Web/API/Document/cookie">Cookies</a></li>
    <li><a href="/en-US/docs/Web/API/Window/localStorage">localStorage</a></li>
    <li><a href="/en-US/docs/Web/API/Window/sessionStorage">sessionStorage</a></li>
    <li><a href="/en-US/docs/Web/API/Cache">DOM Cache</a></li>
    <li><a href="/en-US/docs/Web/API/IndexedDB_API">IndexedDB</a></li>
    <li><a href="/en-US/docs/Web/API/BroadcastChannel">Broadcast Channel</a></li>
    <li><a href="/en-US/docs/Web/API/SharedWorker">Shared Workers</a></li>
    <li><a href="/en-US/docs/Web/API/Service_Worker_API">Service Workers</a></li>
  </ul>

  <h4 id="partitioning_heuristics">Storage Access Heuristics</h4>
  <p>In order to maintain web compatibility Firefox employs heuristics to grant
  storage access automatically.</p>

  <h5>Opener Heuristic</h5>
  <p>
    TODO
    <!-- TODO: Is this the same heuristic as described here:
    https://developer.mozilla.org/en-US/docs/Mozilla/Firefox/Privacy/Storage_access_policy#Automatic_storage_access_upon_interaction
    -->
  </p>

  <h5>Redirect Heuristic</h5>
  <p>Dynamic Storage Partitioning has a heuristic to enable typical login
  flows:</p>
  <p>If a site <code>b.example</code> redirects to <code>a.example</code>, then
  <code>b.example</code> receives storage access to its embedder
  <code>a.example</code> if both <code>a.example</code> and
  <code>b.example</code> have been visited and interacted with within the last 10
  minutes. This storage access will be granted for 30 days.</p>
  <div class="warning">
    <p><strong>Warning</strong>: Storage access heuristics are a transitional
    feature meant to prevent website breakage. They should not be relied upon
    for current and future web development.</p>
  </div>
  <h4 id="storage_access_api">Storage Access API</h5>
  <p>
    Third-party frames may use
    <a href="/en-US/docs/Web/API/Document/requestStorageAccess">
      <code>document.requestStorageAccess</code>
    </a>
    to request access to the first party storage through the
    <a href="/en-US/docs/Web/API/Storage_Access_API">StorageAccessAPI</a>. Once
    granted any requests from the third party frame to storage APIs will be made
    in the context of the first-party.
    <!-- TODO: describe what implications this has on previously partitioned storage -->
  </p>

<h3 id="debugging">Debugging</h2>
<p>
  We encourage site owners to test their sites, particularly those that rely on
  third-party content integrations. There are several features in Firefox to make
  testing easier.
</p>


<h4>Logging</h3>
<p>
  Here is an overview of the messages logged to the web console when
  interacting with storage in a third-party context. In the following examples
<code>a.example</code> is the top level site which embeds the third-party frame
<code>b.example</code>.
</p>

<table class="standard-table">
  <thead>
    <tr>
     <th scope="col">Reason</th>
     <th scope="col">Console Message</th>
    </tr>
   </thead>
  <tbody>
   <tr>
    <th scope="row">Storage of a third-party frame is partitioned</th>
    <td>Partitioned cookie or storage access was provided to “b.example” because it is loaded in the third-party context and storage partitioning is enabled.</td>
   </tr>
   <tr>
    <th scope="row">Storage access is granted through a <b>heuristic</b></th>
    <td>Storage access automatically granted for First-Party isolation “b.example” on “a.example”.</td>
   </tr>
   <tr>
    <th scope="row">Storage access is granted via the <a href="/en-US/docs/Web/API/Document/requestStorageAccess">StorageAccessAPI</a></th>
    <td>Storage access granted for origin “b.example” on “a.example”.</td>
   </tr>
  </tbody>
 </table>

<h4>Clear Third-Party Storage-Access</h4>
<p>
  If a third-party iframe is granted storage access to the parent context,
  Firefox sets a permission. To revoke access you can clear the permission via
  the <a class="external"
  href="https://support.mozilla.org/en-US/kb/site-information-panel">Site
  Information Panel</a> in the permissions section under "Cross-site Cookies".
</p>

<h4>Test Preferences</h3>
<div class="warning">
  <p><strong>Warning</strong>: Make sure to set these prefs in a separate Firefox
  profile or reset them after testing.</p>
</div>

<h5>Disable Heuristics</h4>
<p>
  The following prefs can be used to disable individual storage access
  heuristics via the <a
  class="external"href="https://support.mozilla.org/en-US/kb/about-config-editor-firefox">config
  editor</a>:
</p>
<ul>
  <li><code>privacy.restrict3rdpartystorage.heuristic.recently_visited</code>:
  Allow storage access after redirect for recently visited pages.</li>
  <li><code>privacy.restrict3rdpartystorage.heuristic.recently_visited_time</code>: Allowed time gap since last visit in seconds.</li>
  <li><code>privacy.restrict3rdpartystorage.heuristic.redirect</code>: TODO</li>
  <li><code>privacy.restrict3rdpartystorage.heuristic.window_open</code>: Allow storage access for windows opened using window.open()</li>
</ul>

<h5>Disable Network Partitioning</h4>
<p>Network partitioning can be disabled with the
<code>privacy.partition.network_state</code> pref.</p>

<h5>Disable Dynamic Storage Partitioning</h5>
<p>To disable dynamic storage partitioning for all sites you can use the
<code>network.cookie.cookieBehavior</code> pref:</p>
<table class="standard-table">
  <thead>
    <tr>
     <th scope="col">Value</th>
     <th scope="col">Description</th>
    </tr>
   </thead>
  <tbody>
   <tr>
    <th scope="row">5</th>
    <td>Reject (known) trackers and partition third-party storage.</td>
   </tr>
   <tr>
    <th scope="row">4</th>
    <td>Only reject trackers (Storage partitioning disabled).</td>
   </tr>
   <tr>
    <th scope="row">0</th>
    <td>Allow all</td>
   </tr>
  </tbody>
 </table>

 <p>Partitioning of third-party storage can also be disabled for specific
 origins with the <code>privacy.restrict3rdpartystorage.skip_list</code>
 preference. This pref holds a comma separated list of origins to exempt. For
 example:
</p>
<pre class="notranslate">
 <code>https://tracker.example.com,http://example.com</code>
</pre>
